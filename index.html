<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study Manager ‚Äî Qu·∫£n l√Ω h·ªçc t·∫≠p c√° nh√¢n (M·ªü r·ªông)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa7bf; --accent:#60a5fa; --accent-2:#7c3aed;
      --glass: rgba(255,255,255,0.03); --success:#34d399; --danger:#fb7185; --radius:14px;
      --max-width:1200px; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #071028 100%);color:#e6eef8}
    .container{max-width:var(--max-width);margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 20px rgba(124,58,237,0.18)}
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    nav{display:flex;gap:8px}
    .chip{background:var(--glass);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--muted);cursor:pointer}
    .app{display:grid;grid-template-columns:320px 1fr 360px;gap:18px}
    @media (max-width:1000px){.app{grid-template-columns:1fr;}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:var(--radius);box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    .card h2{margin:0 0 12px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    input[type=text], input[type=date], input[type=time], input[type=number], select, textarea{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:inherit}
    .row{display:flex;gap:8px}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:#04283a;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .task-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto;padding-right:6px}
    .task{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .task .title{font-weight:600}
    .task small{color:var(--muted)}
    .icons{margin-left:auto;display:flex;gap:8px}
    .icon-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px}
    .stats{display:flex;gap:12px;margin-bottom:14px}
    .stat{flex:1;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01))}
    .progress{background:rgba(255,255,255,0.04);height:10px;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .planner{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1000px){.planner{grid-template-columns:1fr}}
    .notes textarea{min-height:120px}
    .timer{display:flex;flex-direction:column;align-items:center;gap:10px}
    .big-time{font-size:42px;font-weight:700}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .tag{padding:6px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,0.02)}
    .empty{color:var(--muted);text-align:center;padding:16px}
    .banner{padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));margin-bottom:12px}
    a { color: var(--accent); text-decoration: none }
    .small-muted{font-size:12px;color:var(--muted)}
    .danger{color:var(--danger)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">SM</div>
        <div>
          <h1>Study Manager</h1>
          <p>Qu·∫£n l√Ω h·ªçc t·∫≠p c√° nh√¢n ‚Äî l√™n k·∫ø ho·∫°ch, th·ªùi kh√≥a bi·ªÉu, theo d√µi ti·∫øn ƒë·ªô</p>
        </div>
      </div>
      <nav>
        <div class="chip">Dashboard</div>
        <div class="chip">Tasks</div>
        <div class="chip">Notes</div>
      </nav>
    </header>

    <main class="app">
      <!-- LEFT: Tasks & TKB quick -->
      <aside class="card sidebar">
        <h2>T·∫°o nhi·ªám v·ª• nhanh</h2>
        <div class="add-task">
          <input id="task-title" type="text" placeholder="T√™n nhi·ªám v·ª• (v√≠ d·ª•: √în To√°n ch∆∞∆°ng 2)" />
          <div class="row">
            <input id="task-date" type="date" />
            <select id="task-priority">
              <option value="low">Th·∫•p</option>
              <option value="medium" selected>Trung b√¨nh</option>
              <option value="high">Cao</option>
            </select>
          </div>
          <div class="row">
            <input id="task-est" type="text" placeholder="Th·ªùi l∆∞·ª£ng (30 ph√∫t)" />
            <button id="add-task">Th√™m</button>
          </div>
        </div>

        <h2 style="margin-top:12px">Danh s√°ch nhi·ªám v·ª•</h2>
        <div id="task-list" class="task-list">
          <div class="empty">Ch∆∞a c√≥ nhi·ªám v·ª• ‚Äî th√™m nhi·ªám v·ª• ·ªü tr√™n</div>
        </div>

        <hr style="margin:12px 0;border:0;border-top:1px dashed rgba(255,255,255,0.03)" />

        <h2>Th·ªùi kh√≥a bi·ªÉu (nhanh)</h2>
        <div class="small-muted">Th√™m m√¥n cho t·ª´ng th·ª©</div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <select id="tkb-day">
            <option value="1">Th·ª© 2</option><option value="2">Th·ª© 3</option><option value="3">Th·ª© 4</option>
            <option value="4">Th·ª© 5</option><option value="5">Th·ª© 6</option><option value="6">Th·ª© 7</option>
            <option value="0">Ch·ªß nh·∫≠t</option>
          </select>
          <input id="tkb-subject" placeholder="T√™n m√¥n (v√≠ d·ª•: To√°n)" />
          <div class="row">
            <input id="tkb-time" type="time" />
            <button id="add-tkb">Th√™m</button>
          </div>
          <div id="tkb-list" class="small-muted" style="max-height:160px; overflow:auto"></div>
        </div>
      </aside>

      <!-- MAIN: Stats, planner, notes, pomodoro, study session -->
      <section>
        <div id="banner-area"></div>

        <div class="card">
          <div class="stats">
            <div class="stat">
              <div class="muted">T·ªïng nhi·ªám v·ª•</div>
              <div style="font-size:20px;font-weight:700;margin-top:6px" id="stat-total">0</div>
            </div>
            <div class="stat">
              <div class="muted">Ho√†n th√†nh</div>
              <div style="font-size:20px;font-weight:700;margin-top:6px" id="stat-done">0</div>
            </div>
            <div class="stat">
              <div class="muted">Ti·∫øn ƒë·ªô</div>
              <div style="margin-top:8px" class="progress"><i id="progress-bar" style="width:0%"></i></div>
            </div>
          </div>

          <div class="planner">
            <div>
              <h2>K·∫ø ho·∫°ch h√¥m nay</h2>
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <input id="planner-date" type="date" />
                <button id="load-today" class="btn-ghost">Xem</button>
              </div>
              <div id="planner-list"></div>

              <div style="margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
                <h2>Th√™m v√†o k·∫ø ho·∫°ch</h2>
                <input id="plan-title" type="text" placeholder="Vi·ªác c·∫ßn l√†m" />
                <div class="row" style="margin-top:8px">
                  <input id="plan-time" type="time" />
                  <button id="add-plan">Th√™m v√†o k·∫ø ho·∫°ch</button>
                </div>
              </div>
            </div>

            <div>
              <h2>Ghi ch√∫ nhanh</h2>
              <div class="notes">
                <textarea id="notes-area" placeholder="Ghi ch√∫, c√¥ng th·ª©c, √Ω t∆∞·ªüng..."></textarea>
                <div style="display:flex;gap:8px;margin-top:8px;justify-content:space-between">
                  <div class="muted">L∆∞u t·ª± ƒë·ªông v√†o tr√¨nh duy·ªát</div>
                  <div>
                    <button id="clear-notes" class="btn-ghost">X√≥a</button>
                    <button id="save-notes">L∆∞u</button>
                  </div>
                </div>
              </div>

              <hr style="margin:12px 0;border:0;border-top:1px dashed rgba(255,255,255,0.03)" />

              <h2>B·ªô h·∫πn gi·ªù (Pomodoro)</h2>
              <div class="timer">
                <div class="big-time" id="timer-display">25:00</div>
                <div class="muted">Chu k√¨: <span id="timer-mode">L√†m vi·ªác</span></div>
                <div class="timer-controls">
                  <button id="start-timer">B·∫Øt ƒë·∫ßu</button>
                  <button id="pause-timer" class="btn-ghost">T·∫°m d·ª´ng</button>
                  <button id="reset-timer" class="btn-ghost">ƒê·∫∑t l·∫°i</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="work-min" type="number" min="1" max="120" value="25" style="width:80px" />
                  <input id="break-min" type="number" min="1" max="60" value="5" style="width:80px" />
                </div>
              </div>

              <hr style="margin:12px 0;border:0;border-top:1px dashed rgba(255,255,255,0.03)" />

              <h2>Th·ªùi gian h·ªçc theo m√¥n</h2>
              <div class="small-muted">ƒê·∫∑t th·ªùi gian cho t·ª´ng m√¥n ‚Äî t·ªïng ph·∫£i t·ª´ 1h (60 ph√∫t) ƒë·∫øn 4h (240 ph√∫t)</div>
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <input id="study-subject" placeholder="T√™n m√¥n (V√≠ d·ª•: To√°n)" />
                <input id="study-min" type="number" placeholder="Ph√∫t" min="5" style="width:120px" />
                <button id="add-study-time">Th√™m</button>
              </div>
              <div id="study-plan" style="margin-top:8px" class="small-muted"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="start-study">B·∫Øt ƒë·∫ßu h·ªçc</button>
                <button id="stop-study" class="btn-ghost">D·ª´ng</button>
              </div>
              <div id="study-timer" style="margin-top:10px" class="muted">Ch∆∞a c√≥ phi√™n h·ªçc</div>
              <div id="support-links" style="margin-top:8px"></div>

            </div>
          </div>
        </div>

        <footer class="card" style="margin-top:12px">
          <div class="muted">L∆∞u √Ω: D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát (localStorage). M·ªü b·∫±ng Visual Studio Code -> L∆∞u file .html -> M·ªü v·ªõi Live Server ƒë·ªÉ tr·∫£i nghi·ªám ƒë·∫ßy ƒë·ªß.</div>
        </footer>
      </section>

      <!-- RIGHT: Filters, Week chart, TKB full, Self-eval -->
      <aside class="card">
        <h2>B·ªô l·ªçc & Th·ªëng k√™</h2>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="filter-all" class="btn-ghost">T·∫•t c·∫£</button>
          <button id="filter-today" class="btn-ghost">H√¥m nay</button>
          <button id="filter-high" class="btn-ghost">∆Øu ti√™n cao</button>
        </div>

        <hr style="margin:12px 0;border:0;border-top:1px dashed rgba(255,255,255,0.03)" />

        <h2>Ti·∫øn tr√¨nh tu·∫ßn</h2>
        <div id="week-chart" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px"></div>

        <hr style="margin:12px 0;border:0;border-top:1px dashed rgba(255,255,255,0.03)" />

        <h2>Th·ªùi kh√≥a bi·ªÉu ƒë·∫ßy ƒë·ªß</h2>
        <div id="tkb-full" style="font-size:13px;margin-top:8px"></div>

        <hr style="margin:12px 0;border:0;border-top:1px dashed rgba(255,255,255,0.03)" />

        <h2>T·ª± ƒë√°nh gi√° & B√†i t·∫≠p</h2>
        <input id="eval-title" type="text" placeholder="T√™n b√†i t·∫≠p / BT" />
        <input id="eval-date" type="date" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="add-eval">Th√™m</button>
        </div>
        <div id="eval-list" style="margin-top:8px"></div>
      </aside>
    </main>
  </div>

  <script>
    const qs = s => document.querySelector(s);
    const qsa = s => document.querySelectorAll(s);
    const nowISODate = () => new Date().toISOString().slice(0,10);
    const dayName = d => {
      const map = {0:'Ch·ªß nh·∫≠t',1:'Th·ª© 2',2:'Th·ª© 3',3:'Th·ª© 4',4:'Th·ª© 5',5:'Th·ª© 6',6:'Th·ª© 7'};
      return map[d];
    };

    const KEY_TASKS = 'sm_tasks_v1';
    const KEY_NOTES = 'sm_notes_v1';
    const KEY_PLANS = 'sm_plans_v1';
    const KEY_TKB = 'sm_tkb_v1';
    const KEY_STUDY = 'sm_study_v1';
    const KEY_SUPPORT = 'sm_support_v1';
    const KEY_EVAL = 'sm_eval_v1';

    let tasks = JSON.parse(localStorage.getItem(KEY_TASKS) || '[]');
    let notes = localStorage.getItem(KEY_NOTES) || '';
    let plans = JSON.parse(localStorage.getItem(KEY_PLANS) || '[]');
    let tkb = JSON.parse(localStorage.getItem(KEY_TKB) || '{}'); 
    let studyPlan = JSON.parse(localStorage.getItem(KEY_STUDY) || '[]'); 
    let supportLinks = JSON.parse(localStorage.getItem(KEY_SUPPORT) || 'null');
    if(!supportLinks){
      supportLinks = {
        'To√°n': ['https://www.youtube.com/results?search_query=h%E1%BB%8Dn+to%C3%A1n','https://khanacademy.org'],
        'VƒÉn': ['https://www.youtube.com/results?search_query=ng%E1%BB%AD+v%C4%83n','https://lop.vn'],
        'Anh': ['https://www.youtube.com/results?search_query=learn+english','https://www.duolingo.com'],
        'L√Ω': ['https://www.youtube.com/results?search_query=v%E1%BA%A5t+l%C3%BD'],
        'H√≥a': ['https://www.youtube.com/results?search_query=h%C3%B3a+h%E1%BB%8Dc']
      };
      localStorage.setItem(KEY_SUPPORT, JSON.stringify(supportLinks));
    }
    let evals = JSON.parse(localStorage.getItem(KEY_EVAL) || '[]');

    const taskListEl = qs('#task-list');
    const statTotal = qs('#stat-total');
    const statDone = qs('#stat-done');
    const progressBar = qs('#progress-bar');
    const tkbListEl = qs('#tkb-list');
    const tkbFullEl = qs('#tkb-full');
    const bannerArea = qs('#banner-area');

    function saveTasks(){ localStorage.setItem(KEY_TASKS, JSON.stringify(tasks)); renderTasks(); renderStats(); renderWeekChart(); }
    function addTask(title, date, priority, est){
      if(!title) return alert('H√£y nh·∫≠p t√™n nhi·ªám v·ª•.');
      tasks.push({id:Date.now(),title, date:date||null, priority, est, done:false});
      saveTasks();
      qs('#task-title').value=''; qs('#task-est').value=''; qs('#task-date').value='';
    }
    function toggleDone(id){ tasks = tasks.map(t=> t.id===id?({...t,done:!t.done}):t); saveTasks(); }
    function deleteTask(id){ if(!confirm('X√≥a nhi·ªám v·ª• n√†y?')) return; tasks = tasks.filter(t=>t.id!==id); saveTasks(); }
    function editTask(id){
      const t = tasks.find(x=>x.id===id); if(!t) return;
      const newTitle = prompt('S·ª≠a t√™n nhi·ªám v·ª•', t.title); if(newTitle!==null){ t.title=newTitle; saveTasks(); }
    }
    function renderTasks(filter='all'){
      taskListEl.innerHTML='';
      let shown = tasks.slice();
      if(filter==='today'){
        const today = nowISODate();
        shown = shown.filter(t=>t.date===today);
      } else if(filter==='high'){ shown = shown.filter(t=>t.priority==='high'); }
      if(shown.length===0){ taskListEl.innerHTML='<div class="empty">Kh√¥ng c√≥ nhi·ªám v·ª• ph√π h·ª£p</div>'; return }
      shown.sort((a,b)=> (a.done - b.done) || (a.priority > b.priority ? -1 : 1));
      for(const t of shown){
        const div = document.createElement('div'); div.className='task';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=t.done; chk.addEventListener('change',()=>toggleDone(t.id));
        const info = document.createElement('div');
        info.innerHTML=`<div class="title">${escapeHtml(t.title)}</div><small>${t.date? 'H·∫°n: '+t.date : ''} ${t.est? ' ‚Ä¢ '+escapeHtml(t.est): ''}</small>`;
        const icons = document.createElement('div'); icons.className='icons';
        const btnEdit = document.createElement('button'); btnEdit.className='icon-btn'; btnEdit.innerText='‚úèÔ∏è'; btnEdit.title='S·ª≠a'; btnEdit.addEventListener('click',()=>editTask(t.id));
        const btnDel = document.createElement('button'); btnDel.className='icon-btn'; btnDel.innerText='üóëÔ∏è'; btnDel.title='X√≥a'; btnDel.addEventListener('click',()=>deleteTask(t.id));
        icons.appendChild(btnEdit); icons.appendChild(btnDel);
        div.appendChild(chk); div.appendChild(info); div.appendChild(icons);
        taskListEl.appendChild(div);
      }
    }
    function renderStats(){
      const total = tasks.length; const done = tasks.filter(t=>t.done).length;
      statTotal.innerText = total; statDone.innerText = done;
      const pct = total===0?0:Math.round((done/total)*100);
      progressBar.style.width = pct+'%';
    }

    function savePlans(){ localStorage.setItem(KEY_PLANS, JSON.stringify(plans)); renderPlanner(qs('#planner-date').value||nowISODate()); }
    function addPlan(title, date, time){ if(!title) return alert('Nh·∫≠p n·ªôi dung k·∫ø ho·∫°ch.'); plans.push({id:Date.now(),title,date,time}); savePlans(); qs('#plan-title').value=''; }
    function deletePlan(id){ if(!confirm('X√≥a k·∫ø ho·∫°ch?')) return; plans = plans.filter(p=>p.id!==id); savePlans(); }
    function renderPlanner(date){
      const el = qs('#planner-list'); el.innerHTML='';
      const list = plans.filter(p=>p.date===date);
      if(list.length===0) { el.innerHTML='<div class="empty">Ch∆∞a c√≥ k·∫ø ho·∫°ch cho ng√†y n√†y</div>'; return }
      list.sort((a,b)=> (a.time||'') > (b.time||'') ? 1:-1);
      for(const p of list){
        const d = document.createElement('div'); d.className='task';
        d.innerHTML=`<div><div class="title">${escapeHtml(p.title)}</div><small>${p.time||''}</small></div>`;
        const icons=document.createElement('div'); icons.className='icons';
        const del=document.createElement('button'); del.className='icon-btn'; del.innerText='üóëÔ∏è'; del.title='X√≥a'; del.addEventListener('click',()=>deletePlan(p.id));
        icons.appendChild(del); d.appendChild(icons);
        el.appendChild(d);
      }
    }

    const notesArea = qs('#notes-area'); notesArea.value = notes;
    function saveNotes(){ notes = notesArea.value; localStorage.setItem(KEY_NOTES, notes); showBanner('Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u', 2000); }
    qs('#save-notes').addEventListener('click', saveNotes);
    qs('#clear-notes').addEventListener('click', ()=>{ if(confirm('X√≥a to√†n b·ªô ghi ch√∫?')){ notesArea.value=''; saveNotes(); }});
    notesArea.addEventListener('input', ()=>{ saveNotes(); });

    qs('#filter-all').addEventListener('click', ()=>{ renderTasks('all'); });
    qs('#filter-today').addEventListener('click', ()=>{ renderTasks('today'); });
    qs('#filter-high').addEventListener('click', ()=>{ renderTasks('high'); });

    qs('#add-task').addEventListener('click', ()=>{ addTask(qs('#task-title').value, qs('#task-date').value, qs('#task-priority').value, qs('#task-est').value); });
    qs('#add-plan').addEventListener('click', ()=>{ const d = qs('#planner-date').value || nowISODate(); addPlan(qs('#plan-title').value, d, qs('#plan-time').value); });
    qs('#load-today').addEventListener('click', ()=>{ renderPlanner(qs('#planner-date').value || nowISODate()); });
    qs('#planner-date').value = nowISODate();

    let timerInterval = null; let timerSeconds = 25*60; let isRunning=false; let isWork=true;
    const timerDisplay = qs('#timer-display'); const timerMode = qs('#timer-mode');
    function updateTimerDisplay(){ const mm = Math.floor(timerSeconds/60).toString().padStart(2,'0'); const ss = (timerSeconds%60).toString().padStart(2,'0'); timerDisplay.innerText = mm+':'+ss; }
    function startTimer(){ if(isRunning) return; isRunning=true; clearInterval(timerInterval); timerInterval=setInterval(()=>{ if(timerSeconds>0){ timerSeconds--; updateTimerDisplay(); } else { clearInterval(timerInterval); isRunning=false; isWork=!isWork; timerMode.innerText = isWork? 'L√†m vi·ªác':'Ngh·ªâ'; timerSeconds = (isWork? parseInt(qs('#work-min').value||25) : parseInt(qs('#break-min').value||5))*60; updateTimerDisplay(); beep(); notify('Study Manager', isWork? 'B·∫Øt ƒë·∫ßu chu k√¨ l√†m vi·ªác':'B·∫Øt ƒë·∫ßu ngh·ªâ ng·∫Øn'); } },1000); }
    function pauseTimer(){ if(timerInterval) clearInterval(timerInterval); isRunning=false; }
    function resetTimer(){ pauseTimer(); isWork=true; timerSeconds = parseInt(qs('#work-min').value||25)*60; timerMode.innerText='L√†m vi·ªác'; updateTimerDisplay(); }
    qs('#start-timer').addEventListener('click', ()=>startTimer());
    qs('#pause-timer').addEventListener('click', ()=>pauseTimer());
    qs('#reset-timer').addEventListener('click', ()=>resetTimer());
    qs('#work-min').addEventListener('change', ()=>{ if(!isRunning){ timerSeconds = parseInt(qs('#work-min').value||25)*60; updateTimerDisplay(); }});
    qs('#break-min').addEventListener('change', ()=>{ if(!isRunning && !isWork){ timerSeconds = parseInt(qs('#break-min').value||5)*60; updateTimerDisplay(); }});

    function renderWeekChart(){ const el = qs('#week-chart'); el.innerHTML=''; const today = new Date();
      for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(today.getDate()-i); const iso = d.toISOString().slice(0,10); const count = tasks.filter(t=>t.date===iso && t.done).length;
        const bar=document.createElement('div'); bar.style.height = Math.min(80,10+count*12)+'px'; bar.style.background='linear-gradient(180deg,var(--accent),var(--accent-2))'; bar.style.borderRadius='8px'; bar.title = d.toLocaleDateString()+' ‚Äî Ho√†n th√†nh: '+count; el.appendChild(bar);
      }
    }

    function saveTKB(){ localStorage.setItem(KEY_TKB, JSON.stringify(tkb)); renderTKBList(); renderTKBFull(); }
    qs('#add-tkb').addEventListener('click', ()=>{
      const day = qs('#tkb-day').value; const subj = qs('#tkb-subject').value.trim(); const time = qs('#tkb-time').value;
      if(!subj) return alert('Nh·∫≠p t√™n m√¥n');
      if(!tkb[day]) tkb[day]=[];
      tkb[day].push({id:Date.now(), subj, time});
      qs('#tkb-subject').value=''; qs('#tkb-time').value='';
      saveTKB();
    });
    function removeTKB(day,id){
      if(!confirm('X√≥a m√¥n n√†y kh·ªèi th·ªùi kh√≥a bi·ªÉu?')) return;
      tkb[day] = (tkb[day]||[]).filter(x=>x.id!==id); saveTKB();
    }
    function renderTKBList(){
      tkbListEl.innerHTML='';
      const keys = Object.keys(tkb).sort();
      if(keys.length===0){ tkbListEl.innerHTML='<div class="small-muted">Ch∆∞a c√≥ th·ªùi kh√≥a bi·ªÉu</div>'; return; }
      for(const k of keys){
        const dname = dayName(Number(k));
        const items = tkb[k]||[];
        const wrap = document.createElement('div'); wrap.style.marginBottom='8px';
        wrap.innerHTML = `<div style="font-weight:700">${dname}</div>`;
        for(const it of items){
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
          row.innerHTML = `<div class="small-muted">${escapeHtml(it.subj)} ${it.time? ' ‚Ä¢ '+it.time:''}</div>`;
          const del = document.createElement('button'); del.className='icon-btn'; del.innerText='üóëÔ∏è'; del.addEventListener('click',()=>removeTKB(k,it.id));
          row.appendChild(del);
          wrap.appendChild(row);
        }
        tkbListEl.appendChild(wrap);
      }
    }
    function renderTKBFull(){
      tkbFullEl.innerHTML='';
      for(let d=1; d<=6; d++){
        const arr = tkb[d] || [];
        const box = document.createElement('div'); box.style.marginBottom='8px';
        box.innerHTML = `<div style="font-weight:700">${dayName(d)}</div><div class="small-muted">${arr.length? arr.map(x=>escapeHtml(x.subj)+(x.time? ' ‚Ä¢ '+x.time:'')).join('<br>') : 'Kh√¥ng c√≥'}</div>`;
        tkbFullEl.appendChild(box);
      }
      const sun = tkb[0]||[]; const sunBox=document.createElement('div'); sunBox.style.marginBottom='8px';
      sunBox.innerHTML = `<div style="font-weight:700">${dayName(0)}</div><div class="small-muted">${sun.length? sun.map(x=>escapeHtml(x.subj)+(x.time? ' ‚Ä¢ '+x.time:'')).join('<br>') : 'Kh√¥ng c√≥'}</div>`;
      tkbFullEl.appendChild(sunBox);
    }

    function saveStudyPlan(){ localStorage.setItem(KEY_STUDY, JSON.stringify(studyPlan)); renderStudyPlanUI(); }
    qs('#add-study-time').addEventListener('click', ()=>{
      const subj = qs('#study-subject').value.trim(); const mins = parseInt(qs('#study-min').value);
      if(!subj || !mins) return alert('Nh·∫≠p m√¥n v√† s·ªë ph√∫t');
      studyPlan.push({id:Date.now(), subj, mins});
      qs('#study-subject').value=''; qs('#study-min').value='';
      const total = studyPlan.reduce((s,x)=>s+x.mins,0);
      if(total < 60 || total > 240){
        showBanner('‚ö† T·ªïng th·ªùi gian hi·ªán t·∫°i: '+total+' ph√∫t ‚Äî y√™u c·∫ßu 60‚Äì240 ph√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu phi√™n h·ªçc', 4000, true);
      }
      saveStudyPlan();
    });
    function removeStudyItem(id){
      studyPlan = studyPlan.filter(x=>x.id!==id); saveStudyPlan();
    }
    function renderStudyPlanUI(){
      const el = qs('#study-plan'); el.innerHTML='';
      if(studyPlan.length===0) { el.innerHTML='<div class="empty">Ch∆∞a c√≥ l·ªãch h·ªçc</div>'; return; }
      let total = 0;
      for(const s of studyPlan){
        total += s.mins;
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        row.innerHTML = `<div>${escapeHtml(s.subj)} ‚Äî ${s.mins} ph√∫t</div>`;
        const del = document.createElement('button'); del.className='icon-btn'; del.innerText='üóëÔ∏è'; del.addEventListener('click',()=>removeStudyItem(s.id));
        row.appendChild(del);
        el.appendChild(row);
      }
      const sum = document.createElement('div'); sum.className='small-muted'; sum.style.marginTop='6px'; sum.innerText = 'T·ªïng: '+total+' ph√∫t';
      el.appendChild(sum);
      if(total < 60 || total > 240){
        const warn = document.createElement('div'); warn.className='danger'; warn.style.marginTop='6px'; warn.innerText='T·ªïng th·ªùi gian ph·∫£i t·ª´ 60 ƒë·∫øn 240 ph√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu.';
        el.appendChild(warn);
      }
    }

    let studyInterval = null;
    let studyIndex = 0;
    let studySeconds = 0;
    function startStudySession(){
      const total = studyPlan.reduce((s,x)=>s+x.mins,0);
      if(total < 60 || total > 240) return alert('T·ªïng th·ªùi gian ph·∫£i t·ª´ 60 ƒë·∫øn 240 ph√∫t tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu phi√™n h·ªçc.');
      if(studyPlan.length===0) return alert('Ch∆∞a c√≥ m√¥n h·ªçc trong l·ªãch!');
      studyIndex = 0;
      startNextSubject();
    }
    function startNextSubject(){
      if(studyIndex >= studyPlan.length){ showBanner('‚úÖ Ho√†n th√†nh phi√™n h·ªçc!', 3000); qs('#study-timer').innerText = 'ƒê√£ ho√†n th√†nh phi√™n h·ªçc.'; notify('Study Manager', 'Phi√™n h·ªçc ƒë√£ ho√†n th√†nh'); return; }
      const cur = studyPlan[studyIndex];
      studySeconds = cur.mins * 60;
      qs('#study-timer').innerText = `ƒêang h·ªçc ${cur.subj} ‚Äî ${cur.mins} ph√∫t`;
      renderSupportLinks(cur.subj);
      notify('Study Manager', 'B·∫Øt ƒë·∫ßu h·ªçc: '+cur.subj+' ‚Äî '+cur.mins+' ph√∫t');
      beep();
      clearInterval(studyInterval);
      studyInterval = setInterval(()=>{
        studySeconds--;
        const mm = Math.floor(studySeconds/60); const ss = studySeconds%60;
        qs('#study-timer').innerText = `ƒêang h·ªçc ${cur.subj} ‚Äî ${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
        if(studySeconds<=0){
          clearInterval(studyInterval);
          beep();
          notify('Study Manager', 'Ho√†n th√†nh m√¥n: '+cur.subj);
          showBanner('‚è∞ H·∫øt th·ªùi gian: '+cur.subj, 2500);
          studyIndex++;
          setTimeout(()=> startNextSubject(), 1200);
        }
      },1000);
    }
    function stopStudySession(){
      if(studyInterval) clearInterval(studyInterval);
      studyInterval = null;
      qs('#study-timer').innerText = 'Phi√™n h·ªçc ƒë√£ d·ª´ng.';
      showBanner('Phi√™n h·ªçc ƒë√£ d·ª´ng', 1500);
    }
    qs('#start-study').addEventListener('click', startStudySession);
    qs('#stop-study').addEventListener('click', stopStudySession);

    function renderSupportLinks(subj){
      const container = qs('#support-links'); container.innerHTML='';
      const links = supportLinks[subj] || supportLinks[guessKey(subj)] || [];
      if(links.length===0){ container.innerHTML = `<div class="small-muted">Kh√¥ng c√≥ link h·ªó tr·ª£ cho ${escapeHtml(subj)} ‚Äî b·∫°n c√≥ th·ªÉ th√™m trong code.</div>`; return; }
      let html = `<div style="font-weight:700">T√†i li·ªáu h·ªó tr·ª£ cho ${escapeHtml(subj)}:</div>`;
      links.forEach(l=> html += `<div><a href="${l}" target="_blank">${l}</a></div>`);
      container.innerHTML = html;
    }
    function guessKey(subj){
      const keys = Object.keys(supportLinks);
      for(const k of keys) if(subj.toLowerCase().includes(k.toLowerCase())) return k;
      return null;
    }

    function saveEvals(){ localStorage.setItem(KEY_EVAL, JSON.stringify(evals)); renderEvals(); }
    qs('#add-eval').addEventListener('click', ()=>{
      const t = qs('#eval-title').value.trim(); const d = qs('#eval-date').value;
      if(!t || !d) return alert('Nh·∫≠p t√™n b√†i t·∫≠p v√† h·∫°n n·ªôp.');
      evals.push({id:Date.now(), title:t, date:d, status:'ch∆∞a'});
      qs('#eval-title').value=''; qs('#eval-date').value='';
      saveEvals();
    });
    function updateEval(id, val){ evals = evals.map(e=> e.id===id? {...e, status: val }: e ); saveEvals(); }
    function deleteEval(id){ if(!confirm('X√≥a b√†i t·∫≠p n√†y?')) return; evals = evals.filter(e=>e.id!==id); saveEvals(); }
    function renderEvals(){
      const el = qs('#eval-list'); el.innerHTML='';
      if(evals.length===0){ el.innerHTML='<div class="small-muted">Ch∆∞a c√≥ b√†i t·∫≠p</div>'; return; }
      const today = nowISODate();
      for(const e of evals){
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='6px';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${escapeHtml(e.title)}</div><div class="small-muted">H·∫°n: ${e.date}${e.date===today? ' ‚Ä¢ H·∫°n h√¥m nay!':''}</div>`;
        const right = document.createElement('div');
        const sel = document.createElement('select'); sel.innerHTML = `<option value="ch∆∞a">ch∆∞a</option><option value="ƒëang">ƒëang</option><option value="xong">xong</option>`; sel.value = e.status; sel.addEventListener('change', ()=>updateEval(e.id, sel.value));
        const del = document.createElement('button'); del.className='icon-btn'; del.innerText='üóëÔ∏è'; del.addEventListener('click', ()=>deleteEval(e.id));
        right.appendChild(sel); right.appendChild(del);
        row.appendChild(left); row.appendChild(right);
        el.appendChild(row);
        const d1 = new Date(e.date); const tnow = new Date(); const diff = (d1 - new Date(tnow.getFullYear(),tnow.getMonth(),tnow.getDate()))/(1000*3600*24);
        if(diff <= 1 && diff >= 0 && e.status !== 'xong'){
          const warn = document.createElement('div'); warn.className='danger'; warn.style.fontSize='12px'; warn.innerText = '‚ö† G·∫ßn ƒë·∫øn h·∫°n n·ªôp!';
          row.appendChild(warn);
          showBanner('‚ö† B√†i t·∫≠p g·∫ßn h·∫°n: '+e.title, 3000, true);
        }
      }
    }

    function showBanner(text, ms=2000, important=false){
      const bn = document.createElement('div'); bn.className='banner'; bn.innerText = text; if(important) bn.style.border = '1px solid rgba(255,255,255,0.06)';
      bannerArea.appendChild(bn);
      setTimeout(()=> { try{ bn.remove(); } catch(e){} }, ms);
    }
    function notify(title, body){
      if('Notification' in window && Notification.permission === 'granted'){
        try{ new Notification(title, {body}); }catch(e){}
      }
    }

    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880;
        o.connect(g); g.connect(ctx.destination); g.gain.value = 0.05;
        o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 200);
      }catch(e){}
    }

    function startUpScheduleNotice(){
      const d = new Date(); const day = d.getDay(); const hour = d.getHours();
      let showDay = day;
      if(day === 6 && hour >= 18){
        showDay = 1; // Monday
      }
      if(day === 0) showDay = 1;
      const arr = tkb[showDay] || [];
      if(arr.length > 0){
        showBanner(`üìÖ L·ªãch ${dayName(showDay)}: ${arr.map(x=>x.subj).join(', ')}`, 7000);
        notify('Study Manager', `L·ªãch ${dayName(showDay)}: ${arr.map(x=>x.subj).join(', ')}`);
      } else {
        const days = [1,2,3,4,5,6,0];
        for(const dd of days){
          if((tkb[dd]||[]).length > 0){
            showBanner(`üìÖ L·ªãch s·∫Øp t·ªõi (${dayName(dd)}): ${(tkb[dd]||[]).map(x=>x.subj).join(', ')}`, 7000);
            break;
          }
        }
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=> ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    renderTasks(); renderStats(); renderPlanner(qs('#planner-date').value); renderWeekChart(); updateTimerDisplay();
    renderTKBList(); renderTKBFull(); renderStudyPlanUI(); renderEvals();

    if('Notification' in window && Notification.permission !== 'granted'){
      try{ Notification.requestPermission(); }catch(e){}
    }

    const origSaveTasks = saveTasks;
    saveTasks = function(){ localStorage.setItem(KEY_TASKS, JSON.stringify(tasks)); renderTasks(); renderStats(); renderWeekChart(); };

    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='n'){ qs('#task-title').focus(); }});

    setTimeout(()=> startUpScheduleNotice(), 800);

    setInterval(()=> {
      renderEvals();
    }, 60*1000);

    window._sm = {tasks, plans, tkb, studyPlan, evals, supportLinks, saveTKB, saveStudyPlan, saveEvals};

  </script>
</body>
</html>
